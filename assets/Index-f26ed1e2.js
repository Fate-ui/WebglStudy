var Z=Object.defineProperty;var $=(d,e,t)=>e in d?Z(d,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[e]=t;var w=(d,e,t)=>($(d,typeof e!="symbol"?e+"":e,t),t),ee=(d,e,t)=>{if(!e.has(d))throw TypeError("Cannot "+t)};var v=(d,e,t)=>(ee(d,e,"read from private field"),t?t.call(d):e.get(d)),V=(d,e,t)=>{if(e.has(d))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(d):e.set(d,t)};import"./base-1fb4ad18.js";import{a as te,E as se}from"./el-radio-a2a7c3cc.js";import{r as Q,I as ae,a as oe,O as re,d as ie,e as K,y as D,V as b,M as ne,aV as X,b as W,af as Y,m as le,b0 as de,S as ce,F as pe,P as he,W as me,b1 as ue,g as ye,E as fe}from"./three.module-4d045381.js";import{O as ge}from"./OrbitControls-67f14f60.js";import{a as we,S as xe,M as Se,R as Me}from"./StaticGeometryGenerator-abc007b9.js";import{u as U,a as be}from"./index-9ea2bc7a.js";import{G as ve,m as Ve}from"./GLTFLoader-673d3693.js";import{d as Ae}from"./index-1a26f821.js";import{d as Pe,s as _e,l as Be,k as Ce,p as Ee,o as ke,c as Ge,h as j,q as z,w as R,a as ze,E as Re,F as We,j as N}from"./index-4e7c88af.js";import"./event-e06a23af.js";import"./use-form-item-26451ce1.js";const q=new D;class De extends re{get isMesh(){return!this.displayEdges}get isLineSegments(){return this.displayEdges}get isLine(){return this.displayEdges}constructor(e,t,s=10,a=0){super(),this.material=t,this.geometry=new ie,this.name="MeshBVHRootVisualizer",this.depth=s,this.displayParents=!1,this.mesh=e,this.displayEdges=!0,this._group=a}raycast(){}update(){const e=this.geometry,t=this.mesh.geometry.boundsTree,s=this._group;if(e.dispose(),this.visible=!1,t){const a=this.depth-1,o=this.displayParents;let h=0;t.traverse((p,l)=>{if(p===a||l)return h++,!0;o&&h++},s);let f=0;const n=new Float32Array(8*3*h);t.traverse((p,l,i)=>{const c=p===a||l;if(c||o){we(0,i,q);const{min:u,max:x}=q;for(let g=-1;g<=1;g+=2){const A=g<0?u.x:x.x;for(let M=-1;M<=1;M+=2){const P=M<0?u.y:x.y;for(let S=-1;S<=1;S+=2){const k=S<0?u.z:x.z;n[f+0]=A,n[f+1]=P,n[f+2]=k,f+=3}}}return c}},s);let y,r;this.displayEdges?r=new Uint8Array([0,4,1,5,2,6,3,7,0,2,1,3,4,6,5,7,0,1,2,3,4,5,6,7]):r=new Uint8Array([0,1,2,2,1,3,4,6,5,6,7,5,1,4,5,0,4,1,2,3,6,3,7,6,0,2,4,2,6,4,1,5,3,3,5,7]),n.length>65535?y=new Uint32Array(r.length*h):y=new Uint16Array(r.length*h);const m=r.length;for(let p=0;p<h;p++){const l=p*8,i=p*m;for(let c=0;c<m;c++)y[i+c]=l+r[c]}e.setIndex(new K(y,1,!1)),e.setAttribute("position",new K(n,3,!1)),this.visible=!0}}}class I extends Q{get color(){return this.edgeMaterial.color}get opacity(){return this.edgeMaterial.opacity}set opacity(e){this.edgeMaterial.opacity=e,this.meshMaterial.opacity=e}constructor(e,t=10){super(),this.name="MeshBVHVisualizer",this.depth=t,this.mesh=e,this.displayParents=!1,this.displayEdges=!0,this._roots=[];const s=new ae({color:65416,transparent:!0,opacity:.3,depthWrite:!1}),a=new oe({color:65416,transparent:!0,opacity:.3,depthWrite:!1});a.color=s.color,this.edgeMaterial=s,this.meshMaterial=a,this.update()}update(){const e=this.mesh.geometry.boundsTree,t=e?e._roots.length:0;for(;this._roots.length>t;){const s=this._roots.pop();s.geometry.dispose(),this.remove(s)}for(let s=0;s<t;s++){if(s>=this._roots.length){const o=new De(this.mesh,this.edgeMaterial,this.depth,s);this.add(o),this._roots.push(o)}const a=this._roots[s];a.depth=this.depth,a.mesh=this.mesh,a.displayParents=this.displayParents,a.displayEdges=this.displayEdges,a.material=this.displayEdges?this.edgeMaterial:this.meshMaterial,a.update()}}updateMatrixWorld(...e){this.position.copy(this.mesh.position),this.rotation.copy(this.mesh.rotation),this.scale.copy(this.mesh.scale),super.updateMatrixWorld(...e)}copy(e){this.depth=e.depth,this.mesh=e.mesh}clone(){return new I(this.mesh,this.depth)}dispose(){this.edgeMaterial.dispose(),this.meshMaterial.dispose();const e=this.children;for(let t=0,s=e.length;t<s;t++)e[t].geometry.dispose()}}var _,B;class Ie{constructor(e,t,s){w(this,"moveState",{forward:!1,backward:!1,left:!1,right:!1,playerIsOnGround:!0});w(this,"playerVelocity",new b);w(this,"player");w(this,"temp",{upVector:new b(0,1,0),tempVector:new b,tempVector2:new b,tempBox:new D,tempMat:new ne,tempSegment:new X});w(this,"params",{playerSpeed:10,gravity:-30});w(this,"controls");w(this,"camera");V(this,_,e=>{const{moveState:t}=this;switch(e.code){case"KeyW":case"ArrowUp":t.forward=!0;break;case"KeyS":case"ArrowDown":t.backward=!0;break;case"KeyA":case"ArrowLeft":t.left=!0;break;case"KeyD":case"ArrowRight":t.right=!0;break;case"Space":t.playerIsOnGround&&(this.playerVelocity.y=10,t.playerIsOnGround=!1)}});V(this,B,e=>{const{moveState:t}=this;switch(e.code){case"KeyW":case"ArrowUp":t.forward=!1;break;case"KeyS":case"ArrowDown":t.backward=!1;break;case"KeyA":case"ArrowLeft":t.left=!1;break;case"KeyD":case"ArrowRight":t.right=!1;break}});w(this,"reset",()=>{const{playerVelocity:e,player:t,camera:s,controls:a}=this;e.set(0,0,0),t.position.set(15.75,-3,30),s.position.sub(a.target),a.target.copy(t.position),s.position.add(t.position),a.update()});U("keydown",v(this,_)),U("keyup",v(this,B)),this.player=e,this.controls=t,this.camera=s}updatePlayer(e,t){const{playerVelocity:s,player:a,params:o,controls:h,camera:f}=this,{playerIsOnGround:n,forward:y,backward:r,right:m,left:p}=this.moveState,{upVector:l,tempVector:i}=this.temp;n?s.y=e*o.gravity:s.y+=e*o.gravity,a.position.addScaledVector(s,e);const c=h.getAzimuthalAngle();y&&(i.set(0,0,-1).applyAxisAngle(l,c),a.position.addScaledVector(i,o.playerSpeed*e)),r&&(i.set(0,0,1).applyAxisAngle(l,c),a.position.addScaledVector(i,o.playerSpeed*e)),p&&(i.set(-1,0,0).applyAxisAngle(l,c),a.position.addScaledVector(i,o.playerSpeed*e)),m&&(i.set(1,0,0).applyAxisAngle(l,c),a.position.addScaledVector(i,o.playerSpeed*e)),a.updateMatrixWorld();const{tempBox:u,tempMat:x,tempSegment:g,tempVector2:A}=this.temp,M=a.capsuleInfo;u.makeEmpty(),x.copy(t.matrixWorld).invert(),g.copy(M.segment),g.start.applyMatrix4(a.matrixWorld).applyMatrix4(x),g.end.applyMatrix4(a.matrixWorld).applyMatrix4(x),u.expandByPoint(g.start),u.expandByPoint(g.end),u.min.addScalar(-M.radius),u.max.addScalar(M.radius),t.geometry.boundsTree.shapecast({intersectsBounds:G=>G.intersectsBox(u),intersectsTriangle:G=>{const L=i,F=A,O=G.closestPointToSegment(g,L,F);if(O<M.radius){const T=M.radius-O,H=F.sub(L).normalize();g.start.addScaledVector(H,T),g.end.addScaledVector(H,T)}}});const P=i;P.copy(g.start).applyMatrix4(t.matrixWorld);const S=A;S.subVectors(P,a.position),this.moveState.playerIsOnGround=S.y>Math.abs(e*s.y*.25);const k=Math.max(0,S.length()-1e-5);S.normalize().multiplyScalar(k),a.position.add(S),n?s.set(0,0,0):(S.normalize(),s.addScaledVector(S,-S.dot(s))),f.position.sub(h.target),h.target.copy(a.position),f.position.add(a.position),a.position.y<-25&&this.reset()}}_=new WeakMap,B=new WeakMap;var C,E;class Le{constructor(e){w(this,"visualizer");w(this,"collider");w(this,"params",{visualizeDepth:10});w(this,"scene");V(this,C,()=>{new ve().load("model/scene.gltf",e=>{const t=e.scene;t.scale.setScalar(.01);const s=new D;s.setFromObject(t),s.getCenter(t.position).negate(),t.updateMatrixWorld(!0);const a={};t.traverse(r=>{if(!(/Boss/.test(r.name)||/Enemie/.test(r.name)||/Shield/.test(r.name)||/Sword/.test(r.name)||/Character/.test(r.name)||/Gate/.test(r.name)||/Cube/.test(r.name)||r.material&&r.material.color.r===1)&&r.isMesh){const m=r.material.color.getHex();a[m]=a[m]||[],a[m].push(r)}});const o=new Q;for(const r in a){const m=a[r],p=[];if(m.forEach(l=>{if(l.material.emissive.r!==0)o.attach(l);else{const i=l.geometry.clone();i.applyMatrix4(l.matrixWorld),p.push(i)}}),p.length){const l=Ve(p),i=new W(l,new Y({color:Number.parseInt(r),shadowSide:2}));i.castShadow=!0,i.receiveShadow=!0,i.material.shadowSide=2,o.add(i)}}const h=new xe(o);h.attributes=["position"];const f=h.generate();f.boundsTree=new Se(f),this.collider=new W(f);const{collider:n,scene:y}=this;n.material.wireframe=!0,n.material.opacity=.5,n.material.transparent=!0,this.visualizer=new I(n,this.params.visualizeDepth),y.add(this.visualizer),y.add(n),y.add(o)})});V(this,E,()=>{const e=new le(16777215,5);e.position.set(1,1.5,1).multiplyScalar(50),e.shadow.mapSize.setScalar(2048),e.shadow.bias=-1e-4,e.shadow.normalBias=.05,e.castShadow=!0;const t=e.shadow.camera;t.bottom=t.left=-30,t.top=30,t.right=45;const{scene:s}=this;s.add(e),s.add(new de(16777215,2241348,.4))});this.scene=e,v(this,C).call(this),v(this,E).call(this)}}C=new WeakMap,E=new WeakMap;const Fe={class:"fixed left-20px top-20px w-300px h-200px bg-white rounded p-15px"},J=2503224/2,Ze=Pe({__name:"Index",setup(d){const e=new ce;e.fog=new pe(J,20,70);const t=new he(75,window.innerWidth/window.innerHeight,.1,50);t.position.set(10,10,-10);const s=new me({antialias:!0});s.setSize(window.innerWidth,window.innerHeight),s.setPixelRatio(window.devicePixelRatio),s.setClearColor(J,1),s.shadowMap.enabled=!0,s.shadowMap.type=ue,s.outputColorSpace=ye;const a=_e();Be(()=>{a.value.appendChild(s.domElement)});const o=new ge(t,s.domElement),h=new fe,f=new Le(e),n=new W(new Me(1,2,1,10,.5),new Y),y=new Ie(n,o,t),r={firstPerson:!1,displayCollider:!1,displayBVH:!1,physicsSteps:5,reset:y.reset};n.geometry.translate(0,-.5,0),n.capsuleInfo={radius:.5,segment:new X(new b,new b(0,-1,0))},n.castShadow=!0,n.receiveShadow=!0,n.material.shadowSide=2,e.add(n),y.reset();const m=Ce("third");function p(){m.value==="third"?(o.maxPolarAngle=Math.PI/2,o.minDistance=1,o.maxDistance=20,t.position.sub(o.target).normalize().multiplyScalar(10).add(o.target)):(o.maxPolarAngle=Math.PI,o.minDistance=1e-4,o.maxDistance=1e-4)}return be(()=>{const{collider:l,visualizer:i}=f,c=Math.min(h.getDelta(),.1);if(l){l.visible=r.displayCollider,i.visible=r.displayBVH;const u=r.physicsSteps;for(let x=0;x<u;x++)y.updatePlayer(c/u,l)}o.update(),s.render(e,t)}),Ee(()=>{Ae(e,s)}),(l,i)=>{const c=se,u=te;return ke(),Ge(We,null,[j("div",{ref_key:"containerRef",ref:a},null,512),j("div",Fe,[z(u,{modelValue:ze(m),"onUpdate:modelValue":i[0]||(i[0]=x=>Re(m)?m.value=x:null),onChange:p},{default:R(()=>[z(c,{label:"third"},{default:R(()=>[N("第三人称")]),_:1}),z(c,{label:"first"},{default:R(()=>[N("第一人称")]),_:1})]),_:1},8,["modelValue"])])],64)}}});export{Ze as default};
