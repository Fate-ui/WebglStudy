var Z=Object.defineProperty;var $=(n,e,t)=>e in n?Z(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var w=(n,e,t)=>($(n,typeof e!="symbol"?e+"":e,t),t),ee=(n,e,t)=>{if(!e.has(n))throw TypeError("Cannot "+t)};var v=(n,e,t)=>(ee(n,e,"read from private field"),t?t.call(n):e.get(n)),V=(n,e,t)=>{if(e.has(n))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(n):e.set(n,t)};import"./base-a34d5a27.js";import{a as te,E as se}from"./el-radio-f34708f9.js";import{r as Y,I as ae,a as oe,O as re,d as ie,e as T,y as D,V as b,M as ne,aU as J,b as W,a8 as Q,m as le,aX as de,S as ce,F as pe,P as he,W as me,aY as ue,g as ye,E as fe}from"./three.module-d28ad747.js";import{O as ge}from"./OrbitControls-3a0e138d.js";import{a as we,S as xe,M as Se,R as Me}from"./StaticGeometryGenerator-e1660f08.js";import{u as U}from"./index-07359fa6.js";import{G as be,m as ve}from"./GLTFLoader-c8c5d735.js";import{d as Ve,s as Ae,l as Be,k as Pe,o as _e,c as Ce,h as j,q as z,w as R,a as Ee,E as ke,F as Ge,j as N}from"./index-a423d614.js";import"./use-form-item-f246e105.js";const q=new D;class ze extends re{get isMesh(){return!this.displayEdges}get isLineSegments(){return this.displayEdges}get isLine(){return this.displayEdges}constructor(e,t,s=10,a=0){super(),this.material=t,this.geometry=new ie,this.name="MeshBVHRootVisualizer",this.depth=s,this.displayParents=!1,this.mesh=e,this.displayEdges=!0,this._group=a}raycast(){}update(){const e=this.geometry,t=this.mesh.geometry.boundsTree,s=this._group;if(e.dispose(),this.visible=!1,t){const a=this.depth-1,o=this.displayParents;let u=0;t.traverse((l,d)=>{if(l===a||d)return u++,!0;o&&u++},s);let g=0;const h=new Float32Array(8*3*u);t.traverse((l,d,i)=>{const m=l===a||d;if(m||o){we(0,i,q);const{min:y,max:x}=q;for(let p=-1;p<=1;p+=2){const A=p<0?y.x:x.x;for(let M=-1;M<=1;M+=2){const B=M<0?y.y:x.y;for(let S=-1;S<=1;S+=2){const k=S<0?y.z:x.z;h[g+0]=A,h[g+1]=B,h[g+2]=k,g+=3}}}return m}},s);let c,r;this.displayEdges?r=new Uint8Array([0,4,1,5,2,6,3,7,0,2,1,3,4,6,5,7,0,1,2,3,4,5,6,7]):r=new Uint8Array([0,1,2,2,1,3,4,6,5,6,7,5,1,4,5,0,4,1,2,3,6,3,7,6,0,2,4,2,6,4,1,5,3,3,5,7]),h.length>65535?c=new Uint32Array(r.length*u):c=new Uint16Array(r.length*u);const f=r.length;for(let l=0;l<u;l++){const d=l*8,i=l*f;for(let m=0;m<f;m++)c[i+m]=d+r[m]}e.setIndex(new T(c,1,!1)),e.setAttribute("position",new T(h,3,!1)),this.visible=!0}}}class I extends Y{get color(){return this.edgeMaterial.color}get opacity(){return this.edgeMaterial.opacity}set opacity(e){this.edgeMaterial.opacity=e,this.meshMaterial.opacity=e}constructor(e,t=10){super(),this.name="MeshBVHVisualizer",this.depth=t,this.mesh=e,this.displayParents=!1,this.displayEdges=!0,this._roots=[];const s=new ae({color:65416,transparent:!0,opacity:.3,depthWrite:!1}),a=new oe({color:65416,transparent:!0,opacity:.3,depthWrite:!1});a.color=s.color,this.edgeMaterial=s,this.meshMaterial=a,this.update()}update(){const e=this.mesh.geometry.boundsTree,t=e?e._roots.length:0;for(;this._roots.length>t;){const s=this._roots.pop();s.geometry.dispose(),this.remove(s)}for(let s=0;s<t;s++){if(s>=this._roots.length){const o=new ze(this.mesh,this.edgeMaterial,this.depth,s);this.add(o),this._roots.push(o)}const a=this._roots[s];a.depth=this.depth,a.mesh=this.mesh,a.displayParents=this.displayParents,a.displayEdges=this.displayEdges,a.material=this.displayEdges?this.edgeMaterial:this.meshMaterial,a.update()}}updateMatrixWorld(...e){this.position.copy(this.mesh.position),this.rotation.copy(this.mesh.rotation),this.scale.copy(this.mesh.scale),super.updateMatrixWorld(...e)}copy(e){this.depth=e.depth,this.mesh=e.mesh}clone(){return new I(this.mesh,this.depth)}dispose(){this.edgeMaterial.dispose(),this.meshMaterial.dispose();const e=this.children;for(let t=0,s=e.length;t<s;t++)e[t].geometry.dispose()}}var P,_;class Re{constructor(e,t,s){w(this,"moveState",{forward:!1,backward:!1,left:!1,right:!1,playerIsOnGround:!0});w(this,"playerVelocity",new b);w(this,"player");w(this,"temp",{upVector:new b(0,1,0),tempVector:new b,tempVector2:new b,tempBox:new D,tempMat:new ne,tempSegment:new J});w(this,"params",{playerSpeed:10,gravity:-30});w(this,"controls");w(this,"camera");V(this,P,e=>{const{moveState:t}=this;switch(e.code){case"KeyW":case"ArrowUp":t.forward=!0;break;case"KeyS":case"ArrowDown":t.backward=!0;break;case"KeyA":case"ArrowLeft":t.left=!0;break;case"KeyD":case"ArrowRight":t.right=!0;break;case"Space":t.playerIsOnGround&&(this.playerVelocity.y=10,t.playerIsOnGround=!1)}});V(this,_,e=>{const{moveState:t}=this;switch(e.code){case"KeyW":case"ArrowUp":t.forward=!1;break;case"KeyS":case"ArrowDown":t.backward=!1;break;case"KeyA":case"ArrowLeft":t.left=!1;break;case"KeyD":case"ArrowRight":t.right=!1;break}});w(this,"reset",()=>{const{playerVelocity:e,player:t,camera:s,controls:a}=this;e.set(0,0,0),t.position.set(15.75,-3,30),s.position.sub(a.target),a.target.copy(t.position),s.position.add(t.position),a.update()});U("keydown",v(this,P)),U("keyup",v(this,_)),this.player=e,this.controls=t,this.camera=s}updatePlayer(e,t){const{playerVelocity:s,player:a,params:o,controls:u,camera:g}=this,{playerIsOnGround:h,forward:c,backward:r,right:f,left:l}=this.moveState,{upVector:d,tempVector:i}=this.temp;h?s.y=e*o.gravity:s.y+=e*o.gravity,a.position.addScaledVector(s,e);const m=u.getAzimuthalAngle();c&&(i.set(0,0,-1).applyAxisAngle(d,m),a.position.addScaledVector(i,o.playerSpeed*e)),r&&(i.set(0,0,1).applyAxisAngle(d,m),a.position.addScaledVector(i,o.playerSpeed*e)),l&&(i.set(-1,0,0).applyAxisAngle(d,m),a.position.addScaledVector(i,o.playerSpeed*e)),f&&(i.set(1,0,0).applyAxisAngle(d,m),a.position.addScaledVector(i,o.playerSpeed*e)),a.updateMatrixWorld();const{tempBox:y,tempMat:x,tempSegment:p,tempVector2:A}=this.temp,M=a.capsuleInfo;y.makeEmpty(),x.copy(t.matrixWorld).invert(),p.copy(M.segment),p.start.applyMatrix4(a.matrixWorld).applyMatrix4(x),p.end.applyMatrix4(a.matrixWorld).applyMatrix4(x),y.expandByPoint(p.start),y.expandByPoint(p.end),y.min.addScalar(-M.radius),y.max.addScalar(M.radius),t.geometry.boundsTree.shapecast({intersectsBounds:G=>G.intersectsBox(y),intersectsTriangle:G=>{const L=i,F=A,O=G.closestPointToSegment(p,L,F);if(O<M.radius){const H=M.radius-O,K=F.sub(L).normalize();p.start.addScaledVector(K,H),p.end.addScaledVector(K,H)}}});const B=i;B.copy(p.start).applyMatrix4(t.matrixWorld);const S=A;S.subVectors(B,a.position),this.moveState.playerIsOnGround=S.y>Math.abs(e*s.y*.25);const k=Math.max(0,S.length()-1e-5);S.normalize().multiplyScalar(k),a.position.add(S),h?s.set(0,0,0):(S.normalize(),s.addScaledVector(S,-S.dot(s))),g.position.sub(u.target),u.target.copy(a.position),g.position.add(a.position),a.position.y<-25&&this.reset()}}P=new WeakMap,_=new WeakMap;var C,E;class We{constructor(e){w(this,"visualizer");w(this,"collider");w(this,"params",{visualizeDepth:10});w(this,"scene");V(this,C,()=>{new be().load("model/scene.gltf",e=>{const t=e.scene;t.scale.setScalar(.01);const s=new D;s.setFromObject(t),s.getCenter(t.position).negate(),t.updateMatrixWorld(!0);const a={};t.traverse(r=>{if(!(/Boss/.test(r.name)||/Enemie/.test(r.name)||/Shield/.test(r.name)||/Sword/.test(r.name)||/Character/.test(r.name)||/Gate/.test(r.name)||/Cube/.test(r.name)||r.material&&r.material.color.r===1)&&r.isMesh){const f=r.material.color.getHex();a[f]=a[f]||[],a[f].push(r)}});const o=new Y;for(const r in a){const f=a[r],l=[];if(f.forEach(d=>{if(d.material.emissive.r!==0)o.attach(d);else{const i=d.geometry.clone();i.applyMatrix4(d.matrixWorld),l.push(i)}}),l.length){const d=ve(l),i=new W(d,new Q({color:Number.parseInt(r),shadowSide:2}));i.castShadow=!0,i.receiveShadow=!0,i.material.shadowSide=2,o.add(i)}}const u=new xe(o);u.attributes=["position"];const g=u.generate();g.boundsTree=new Se(g),this.collider=new W(g);const{collider:h,scene:c}=this;h.material.wireframe=!0,h.material.opacity=.5,h.material.transparent=!0,this.visualizer=new I(h,this.params.visualizeDepth),c.add(this.visualizer),c.add(h),c.add(o)})});V(this,E,()=>{const e=new le(16777215,5);e.position.set(1,1.5,1).multiplyScalar(50),e.shadow.mapSize.setScalar(2048),e.shadow.bias=-1e-4,e.shadow.normalBias=.05,e.castShadow=!0;const t=e.shadow.camera;t.bottom=t.left=-30,t.top=30,t.right=45;const{scene:s}=this;s.add(e),s.add(new de(16777215,2241348,.4))});this.scene=e,v(this,C).call(this),v(this,E).call(this)}}C=new WeakMap,E=new WeakMap;const De={class:"fixed left-20px top-20px w-300px h-200px bg-white rounded p-15px"},X=2503224/2,qe=Ve({__name:"Index",setup(n){const e=new ce;e.fog=new pe(X,20,70);const t=new he(75,window.innerWidth/window.innerHeight,.1,50);t.position.set(10,10,-10);const s=new me({antialias:!0});s.setSize(window.innerWidth,window.innerHeight),s.setPixelRatio(window.devicePixelRatio),s.setClearColor(X,1),s.shadowMap.enabled=!0,s.shadowMap.type=ue,s.outputColorSpace=ye;const a=Ae();Be(()=>{a.value.appendChild(s.domElement)});const o=new ge(t,s.domElement),u=new fe,g=new We(e);function h(){requestAnimationFrame(h);const{collider:i,visualizer:m}=g,y=Math.min(u.getDelta(),.1);if(i){i.visible=f.displayCollider,m.visible=f.displayBVH;const x=f.physicsSteps;for(let p=0;p<x;p++)r.updatePlayer(y/x,i)}o.update(),s.render(e,t)}const c=new W(new Me(1,2,1,10,.5),new Q),r=new Re(c,o,t),f={firstPerson:!1,displayCollider:!1,displayBVH:!1,physicsSteps:5,reset:r.reset};c.geometry.translate(0,-.5,0),c.capsuleInfo={radius:.5,segment:new J(new b,new b(0,-1,0))},c.castShadow=!0,c.receiveShadow=!0,c.material.shadowSide=2,e.add(c),r.reset(),h();const l=Pe("third");function d(){l.value==="third"?(o.maxPolarAngle=Math.PI/2,o.minDistance=1,o.maxDistance=20,t.position.sub(o.target).normalize().multiplyScalar(10).add(o.target)):(o.maxPolarAngle=Math.PI,o.minDistance=1e-4,o.maxDistance=1e-4)}return(i,m)=>{const y=se,x=te;return _e(),Ce(Ge,null,[j("div",{ref_key:"containerRef",ref:a},null,512),j("div",De,[z(x,{modelValue:Ee(l),"onUpdate:modelValue":m[0]||(m[0]=p=>ke(l)?l.value=p:null),onChange:d},{default:R(()=>[z(y,{label:"third"},{default:R(()=>[N("第三人称")]),_:1}),z(y,{label:"first"},{default:R(()=>[N("第一人称")]),_:1})]),_:1},8,["modelValue"])])],64)}}});export{qe as default};
